<!--
Copyright (C) 2014 Milo Yip

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
-->
<html>

<head>
  <script src="https://code.jquery.com/jquery-1.8.2.js"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.8.12/jquery.csv.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  <script>
    google.load("visualization", "1", { packages: ["corechart", "table"] });
    google.setOnLoadCallback(drawChart);
    function drawChart() {
      var csv = $('#textInput').val();
      var data = $.csv.toArrays(csv, {
        onParseValue: $.csv.hooks.castToScalar
      });

      // Convert data for bar chart (summing all digits)
      var timeData = {};	// type -> table
      var funcRowMap;
      var maxDigit = 0;

      for (var i = 1; i < data.length; i++) {
        var type = data[i][0];
        var func = data[i][1];
        var digit = data[i][2];
        var time = data[i][3];
        if (timeData[type] == null) {
          timeData[type] = [["Function", "Time (ns)"/*, { role: "style" }*/]];
          if (digit != 0)
            funcRowMap = {};
        }

        var table = timeData[type];

        if (digit != 0) {
          if (funcRowMap[func] == null)
            funcRowMap[func] = table.push([func, 0]) - 1;

          table[funcRowMap[func]][1] += time;
        }
        else
          table.push([func, time]);

        maxDigit = Math.max(maxDigit, digit);
      }

      // Compute average
      for (var type in timeData) {
        var table = timeData[type];
        for (var i = 1; i < table.length; i++)
          table[i][1] /= maxDigit;
      }

      // Convert data for drawing line chart per random digit
      var timeDigitData = {}; // type -> table
      var funcColumnMap;

      for (var i = 1; i < data.length; i++) {
        var type = data[i][0];
        var func = data[i][1];
        var digit = data[i][2];
        var time = data[i][3];

        if (digit == 0)
          continue;

        if (timeDigitData[type] == null) {
          timeDigitData[type] = [["Digit"]];
          funcColumnMap = {};
        }

        var table = timeDigitData[type];

        if (funcColumnMap[func] == null)
          funcColumnMap[func] = table[0].push(func) - 1;

        var row;
        for (row = 1; row < table.length; row++)
          if (table[row][0] == digit)
            break;

        if (row == table.length)
          table.push([digit]);

        table[row][funcColumnMap[func]] = time;
      }

      for (var type in timeData) {
        $("#main").append(
          $("<a>", { name: type }),
          $("<h2>", { style: "padding-top: 70px; margin-top: -70px;" }).append(type)
        );

        $("#section").append($("<li>").append($("<a>", { href: "#" + type }).append(type)));

        drawTable(type, timeData[type]);
        drawBarChart(type, timeData[type]);
        if (timeDigitData[type] != null)
          drawDigitChart(type, timeDigitData[type]);
      }

      $(".chart").each(function () {
        var chart = $(this);
        var d = $("#downloadDD").clone().css("display", "");
        $('li a', d).each(function () {
          $(this).click(function () {
            var svg = chart[0].getElementsByTagName('svg')[0].parentNode.innerHTML;
            svg = sanitize(svg);
            $('#imageFilename').val($("#title").html() + "_" + chart.data("filename"));
            $('#imageGetFormTYPE').val($(this).attr('dltype'));
            $('#imageGetFormSVG').val(svg);
            $('#imageGetForm').submit();
          });
        });
        $(this).after(d);
      });

      // Add configurations
      var thisConfig = "epyc-milan-processor_linux_gcc11.5_69644a9";
      var configurations = [];

      for (var i in configurations) {
        var c = configurations[i];
        $("#configuration").append($("<li>", { class: (c == thisConfig ? "active" : "") }).append($("<a>", { href: c + ".html" }).append(c)));
      }
    }

    function drawTable(type, timeData) {
      var data = google.visualization.arrayToDataTable(timeData);
      data.addColumn('number', 'Speedup');
      data.sort([{ column: 1, desc: true }]);
      var formatter1 = new google.visualization.NumberFormat({ fractionDigits: 3 });
      formatter1.format(data, 1);

      var div = document.createElement("div");
      div.className = "tablechart";
      $("#main").append(div);
      var table = new google.visualization.Table(div);
      redrawTable(0);
      table.setSelection([{ row: 0, column: null }]);

      function redrawTable(selectedRow) {
        // Compute relative time using the first row as basis
        var basis = data.getValue(selectedRow, 1);
        for (var rowIndex = 0; rowIndex < data.getNumberOfRows(); rowIndex++)
          data.setValue(rowIndex, 2, basis / data.getValue(rowIndex, 1));

        var formatter = new google.visualization.NumberFormat({ suffix: 'x' });
        formatter.format(data, 2); // Apply formatter to second column

        table.draw(data);
      }

      google.visualization.events.addListener(table, 'select',
        function () {
          var selection = table.getSelection();
          if (selection.length > 0) {
            var item = selection[0];
            if (item.row != null)
              redrawTable(item.row);
          }
        });

    }

    function drawBarChart(type, timeData) {
      var defaultColors = [
        "#3366cc", "#dc3912", "#ff9900", "#109618", "#990099", "#0099c6", "#dd4477",
        "#66aa00", "#b82e2e", "#316395", "#994499", "#22aa99", "#aaaa11", "#6633cc",
        "#e67300", "#8b0707", "#651067", "#329262", "#5574a6", "#3b3eac", "#b77322",
        "#16d620", "#b91383", "#f4359e", "#9c5935", "#a9c413", "#2a778d", "#668d1c",
        "#bea413", "#0c5922", "#743411"
      ];

      // Filter out methods that are too slow.
      var excluded = {
        "ostringstream": true,
        "sprintf": true
      };
      var filtered = [timeData[0]];
      for (var i = 1; i < timeData.length; i++) {
        if (!excluded[timeData[i][0]])
          filtered.push(timeData[i]);
      }

      var data = google.visualization.arrayToDataTable(filtered);
      data.addColumn({ type: "string", role: "style" })
      for (var rowIndex = 0; rowIndex < data.getNumberOfRows(); rowIndex++)
        data.setValue(rowIndex, 2, defaultColors[rowIndex]);

      data.sort([{ column: 1, desc: true }]);
      var options = {
        title: type,
        chartArea: { 'width': '70%', 'height': '70%' },
        width: 800,
        height: 300,
        legend: { position: "none" },
        hAxis: { title: "Time (ns)" }
      };
      var div = document.createElement("div");
      div.className = "chart";
      $(div).data("filename", type + "_time");
      $("#main").append(div);
      var chart = new google.visualization.BarChart(div);

      chart.draw(data, options);
    }

    function drawDigitChart(type, timeDigitData) {
      var data = google.visualization.arrayToDataTable(timeDigitData);

      var options = {
        title: type,
        chartArea: {
          'left': 80,
          'width': '60%',
          'height': '80%'
        },
        hAxis: {
          title: "Digit",
          gridlines: { count: timeDigitData.length - 1 },
          maxAlternation: 1,
          minTextSpacing: 0
        },
        vAxis: {
          title: "Time (ns) in log scale",
          logScale: true,
          minorGridlines: { count: 10 },
          baseline: 0
        },
        width: 800,
        height: 600
      };
      var div = document.createElement("div");
      div.className = "chart";
      $(div).data("filename", type + "_timedigit");
      $("#main").append(div);
      var chart = new google.visualization.LineChart(div);

      chart.draw(data, options);
    }

    // http://jsfiddle.net/P6XXM/
    function sanitize(svg) {
      svg = svg
        .replace(/\<svg/, '<svg xmlns="http://www.w3.org/2000/svg" version="1.1"')
        .replace(/zIndex="[^"]+"/g, '')
        .replace(/isShadow="[^"]+"/g, '')
        .replace(/symbolName="[^"]+"/g, '')
        .replace(/jQuery[0-9]+="[^"]+"/g, '')
        .replace(/isTracker="[^"]+"/g, '')
        .replace(/url\([^#]+#/g, 'url(#')
        .replace('<svg xmlns:xlink="http://www.w3.org/1999/xlink" ', '<svg ')
        .replace(/ href=/g, ' xlink:href=')
        /*.replace(/preserveAspectRatio="none">/g, 'preserveAspectRatio="none"/>')*/
        /* This fails in IE < 8
        .replace(/([0-9]+)\.([0-9]+)/g, function(s1, s2, s3) { // round off to save weight
        return s2 +'.'+ s3[0];
        })*/

        // IE specific
        .replace(/id=([^" >]+)/g, 'id="$1"')
        .replace(/class=([^" ]+)/g, 'class="$1"')
        .replace(/ transform /g, ' ')
        .replace(/:(path|rect)/g, '$1')
        .replace(/<img ([^>]*)>/gi, '<image $1 />')
        .replace(/<\/image>/g, '') // remove closing tags for images as they'll never have any content
        .replace(/<image ([^>]*)([^\/])>/gi, '<image $1$2 />') // closes image tags for firefox
        .replace(/width=(\d+)/g, 'width="$1"')
        .replace(/height=(\d+)/g, 'height="$1"')
        .replace(/hc-svg-href="/g, 'xlink:href="')
        .replace(/style="([^"]+)"/g, function (s) {
          return s.toLowerCase();
        });

      // IE9 beta bugs with innerHTML. Test again with final IE9.
      svg = svg.replace(/(url\(#highcharts-[0-9]+)&quot;/g, '$1')
        .replace(/&quot;/g, "'");
      if (svg.match(/ xmlns="/g).length == 2) {
        svg = svg.replace(/xmlns="[^"]+"/, '');
      }

      return svg;
    }
  </script>
  <style type="text/css">
    @media (min-width: 800px) {
      .container {
        max-width: 800px;
      }
    }

    textarea {
      font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace;
    }

    .tablechart {
      width: 700px;
      margin: auto;
      padding-top: 20px;
      padding-bottom: 20px;
    }

    .chart {
      padding-top: 20px;
      padding-bottom: 20px;
    }

    body {
      padding-top: 70px;
    }
  </style>
</head>

<body>
  <div class="container">
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse"
            data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="https://github.com/fmtlib/dtoa-benchmark"><span
              class="glyphicon glyphicon-home"></span> dtoa-benchmark</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Configuration <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu" id="configuration">
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Section <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu" id="section">
              </ul>
            </li>
          </ul>
          <p class="navbar-text navbar-right">Developed by <a href="https://github.com/miloyip" class="navbar-link">Milo
              Yip</a></p>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>
    <div class="page-header">
      <h1 id="title">epyc-milan-processor_linux_gcc11.5_69644a9</h1>
    </div>
    <div id="main"></div>
    <h2>Source CSV</h2>
    <textarea id="textInput" class="form-control" rows="5" readonly>
Type,Function,Digit,Time(ns)
randomdigit,double-conversion,1,66.601781
randomdigit,double-conversion,2,74.962042
randomdigit,double-conversion,3,81.073379
randomdigit,double-conversion,4,84.588499
randomdigit,double-conversion,5,87.985318
randomdigit,double-conversion,6,90.957336
randomdigit,double-conversion,7,93.540063
randomdigit,double-conversion,8,95.193917
randomdigit,double-conversion,9,96.230740
randomdigit,double-conversion,10,97.835364
randomdigit,double-conversion,11,100.015569
randomdigit,double-conversion,12,102.309407
randomdigit,double-conversion,13,104.652992
randomdigit,double-conversion,14,106.777299
randomdigit,double-conversion,15,109.916877
randomdigit,double-conversion,16,113.908778
randomdigit,double-conversion,17,120.454036
randomdigit,dragonbox,1,27.850996
randomdigit,dragonbox,2,29.470259
randomdigit,dragonbox,3,29.279939
randomdigit,dragonbox,4,30.226732
randomdigit,dragonbox,5,29.464220
randomdigit,dragonbox,6,30.477873
randomdigit,dragonbox,7,29.882950
randomdigit,dragonbox,8,30.655264
randomdigit,dragonbox,9,30.360832
randomdigit,dragonbox,10,31.021724
randomdigit,dragonbox,11,30.683403
randomdigit,dragonbox,12,31.716356
randomdigit,dragonbox,13,31.247804
randomdigit,dragonbox,14,32.273887
randomdigit,dragonbox,15,32.096927
randomdigit,dragonbox,16,33.019849
randomdigit,dragonbox,17,35.494796
randomdigit,fmt,1,35.166935
randomdigit,fmt,2,36.671730
randomdigit,fmt,3,37.665452
randomdigit,fmt,4,37.122791
randomdigit,fmt,5,38.107843
randomdigit,fmt,6,37.376571
randomdigit,fmt,7,38.235993
randomdigit,fmt,8,37.918883
randomdigit,fmt,9,42.001253
randomdigit,fmt,10,41.255722
randomdigit,fmt,11,42.219074
randomdigit,fmt,12,41.735272
randomdigit,fmt,13,42.162764
randomdigit,fmt,14,42.067315
randomdigit,fmt,15,42.155424
randomdigit,fmt,16,41.610932
randomdigit,fmt,17,48.186321
randomdigit,null,1,2.761688
randomdigit,null,2,2.762777
randomdigit,null,3,2.768417
randomdigit,null,4,2.763788
randomdigit,null,5,2.765498
randomdigit,null,6,2.767337
randomdigit,null,7,2.764237
randomdigit,null,8,2.764777
randomdigit,null,9,2.767028
randomdigit,null,10,2.768117
randomdigit,null,11,2.764117
randomdigit,null,12,2.763248
randomdigit,null,13,2.767587
randomdigit,null,14,2.766408
randomdigit,null,15,2.766437
randomdigit,null,16,2.765317
randomdigit,null,17,2.768628
randomdigit,ostringstream,1,919.464373
randomdigit,ostringstream,2,926.795822
randomdigit,ostringstream,3,934.095843
randomdigit,ostringstream,4,938.584994
randomdigit,ostringstream,5,945.467633
randomdigit,ostringstream,6,951.855271
randomdigit,ostringstream,7,939.206667
randomdigit,ostringstream,8,941.541563
randomdigit,ostringstream,9,952.389002
randomdigit,ostringstream,10,968.155895
randomdigit,ostringstream,11,975.928275
randomdigit,ostringstream,12,981.220284
randomdigit,ostringstream,13,984.870363
randomdigit,ostringstream,14,986.866218
randomdigit,ostringstream,15,985.142034
randomdigit,ostringstream,16,987.247920
randomdigit,ostringstream,17,982.273895
randomdigit,ryu,1,63.485571
randomdigit,ryu,2,63.664512
randomdigit,ryu,3,61.399176
randomdigit,ryu,4,60.273842
randomdigit,ryu,5,58.918138
randomdigit,ryu,6,57.198754
randomdigit,ryu,7,56.190781
randomdigit,ryu,8,55.009258
randomdigit,ryu,9,53.848336
randomdigit,ryu,10,54.512227
randomdigit,ryu,11,52.502060
randomdigit,ryu,12,50.980448
randomdigit,ryu,13,49.116322
randomdigit,ryu,14,47.261848
randomdigit,ryu,15,46.650695
randomdigit,ryu,16,44.571311
randomdigit,ryu,17,44.867721
randomdigit,schubfach,1,39.356946
randomdigit,schubfach,2,41.621953
randomdigit,schubfach,3,40.815990
randomdigit,schubfach,4,40.018317
randomdigit,schubfach,5,39.549457
randomdigit,schubfach,6,39.101945
randomdigit,schubfach,7,38.890575
randomdigit,schubfach,8,38.299434
randomdigit,schubfach,9,37.541852
randomdigit,schubfach,10,48.894372
randomdigit,schubfach,11,50.376946
randomdigit,schubfach,12,50.044616
randomdigit,schubfach,13,49.744563
randomdigit,schubfach,14,48.978582
randomdigit,schubfach,15,48.737852
randomdigit,schubfach,16,49.799493
randomdigit,schubfach,17,53.629254
randomdigit,sprintf,1,522.814328
randomdigit,sprintf,2,531.640432
randomdigit,sprintf,3,540.346486
randomdigit,sprintf,4,541.994441
randomdigit,sprintf,5,551.244614
randomdigit,sprintf,6,555.476925
randomdigit,sprintf,7,556.801280
randomdigit,sprintf,8,563.653068
randomdigit,sprintf,9,564.579821
randomdigit,sprintf,10,570.899938
randomdigit,sprintf,11,576.355142
randomdigit,sprintf,12,578.495517
randomdigit,sprintf,13,582.725249
randomdigit,sprintf,14,586.138729
randomdigit,sprintf,15,581.597496
randomdigit,sprintf,16,585.242826
randomdigit,sprintf,17,581.359826
randomdigit,to_chars,1,76.563566
randomdigit,to_chars,2,77.514929
randomdigit,to_chars,3,75.492562
randomdigit,to_chars,4,73.969180
randomdigit,to_chars,5,72.966036
randomdigit,to_chars,6,70.966930
randomdigit,to_chars,7,69.580248
randomdigit,to_chars,8,68.224565
randomdigit,to_chars,9,65.970957
randomdigit,to_chars,10,66.631570
randomdigit,to_chars,11,65.134075
randomdigit,to_chars,12,63.295190
randomdigit,to_chars,13,61.397976
randomdigit,to_chars,14,60.137932
randomdigit,to_chars,15,58.318327
randomdigit,to_chars,16,56.840744
randomdigit,to_chars,17,57.945217
randomdigit,xjb64,1,19.091711
randomdigit,xjb64,2,19.245872
randomdigit,xjb64,3,19.289272
randomdigit,xjb64,4,19.305771
randomdigit,xjb64,5,19.294303
randomdigit,xjb64,6,19.332272
randomdigit,xjb64,7,19.287943
randomdigit,xjb64,8,19.281071
randomdigit,xjb64,9,19.308101
randomdigit,xjb64,10,19.292761
randomdigit,xjb64,11,19.320453
randomdigit,xjb64,12,19.296202
randomdigit,xjb64,13,19.310781
randomdigit,xjb64,14,19.291332
randomdigit,xjb64,15,19.286602
randomdigit,xjb64,16,19.209652
randomdigit,xjb64,17,19.226092
randomdigit,yy,1,22.811341
randomdigit,yy,2,22.831422
randomdigit,yy,3,22.848221
randomdigit,yy,4,22.841132
randomdigit,yy,5,24.833947
randomdigit,yy,6,26.786782
randomdigit,yy,7,26.356331
randomdigit,yy,8,26.342320
randomdigit,yy,9,27.572823
randomdigit,yy,10,28.327456
randomdigit,yy,11,28.119487
randomdigit,yy,12,28.121726
randomdigit,yy,13,29.254689
randomdigit,yy,14,30.514552
randomdigit,yy,15,30.380541
randomdigit,yy,16,29.609310
randomdigit,yy,17,30.749703
randomdigit,zmij,1,18.901551
randomdigit,zmij,2,18.911741
randomdigit,zmij,3,18.929651
randomdigit,zmij,4,18.907361
randomdigit,zmij,5,18.890401
randomdigit,zmij,6,18.903762
randomdigit,zmij,7,18.892571
randomdigit,zmij,8,18.895480
randomdigit,zmij,9,18.919951
randomdigit,zmij,10,18.913311
randomdigit,zmij,11,18.901301
randomdigit,zmij,12,18.902512
randomdigit,zmij,13,18.893591
randomdigit,zmij,14,18.887691
randomdigit,zmij,15,18.841540
randomdigit,zmij,16,20.395745
randomdigit,zmij,17,22.411240
</textarea>
  </div>
  <div class="row" id="downloadDD" style="display: none">
    <div class="btn-group pull-right">
      <button class="btn dropdown-toggle" data-toggle="dropdown"><span
          class="glyphicon glyphicon-picture"></span></button>
      <ul class="dropdown-menu">
        <li><a tabindex="-1" href="#" dltype="image/jpeg">JPEG</a></li>
        <li><a tabindex="-1" href="#" dltype="image/png">PNG</a></li>
        <li><a tabindex="-1" href="#" dltype="application/pdf">PDF</a></li>
        <li><a tabindex="-1" href="#" dltype="image/svg+xml">SVG</a></li>
      </ul>
    </div>
  </div>
  <form method="post" action="http://export.highcharts.com/" id="imageGetForm">
    <input type="hidden" name="filename" id="imageFilename" value="" />
    <input type="hidden" name="type" id="imageGetFormTYPE" value="" />
    <input type="hidden" name="width" value="900" />
    <input type="hidden" name="svg" value="" id="imageGetFormSVG" />
  </form>
  </div>
</body>

</html>